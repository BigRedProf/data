using BigRedProf.Data.PackRatCompiler.Internal;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace BigRedProf.Data.PackRatCompiler
{
	/// <summary>
	/// This class can generate a <see cref="PackRat"/> class from a given model.
	/// </summary>
	public class PackRatGenerator
	{
		#region methods
		/// <summary>
		/// Generates a <see cref="PackRat"/> from the specified input model and writes it
		/// to the specified output model stream.
		/// </summary>
		/// <param name="inputModelStream">The model.</param>
		/// <param name="outputPackRatStream">The generated pack rat.</param>
		public void GeneratePackRat(Stream inputModelStream, Stream outputPackRatStream)
		{
			if (inputModelStream == null)
				throw new ArgumentNullException(nameof(inputModelStream));

			if (outputPackRatStream == null)
				throw new ArgumentNullException(nameof(outputPackRatStream));

			SourceFile sourceFile = new SourceFile(inputModelStream);
			if (sourceFile.RegistersPackRat())
			{
				using (CSharpWriter writer = new CSharpWriter(outputPackRatStream))
				{
					WriteFile(sourceFile, writer);
				}
			}
		}
		#endregion

		#region private methods
		private void WriteFile(SourceFile sourceFile, CSharpWriter writer)
		{
			writer.WriteLine("// <auto-generated/>");

			string @namespace = sourceFile.GetNamespace();
			writer.WriteLine($"namespace {@namespace}");
			IEnumerable<SyntaxNode> modelClasses = sourceFile.GetModelClasses();
			writer.WriteOpeningCurlyBrace();
			foreach (ClassDeclarationSyntax modelClass in modelClasses)
				WritePackRatClass(sourceFile, modelClass, writer);
			writer.WriteClosingCurlyBrace();
		}

		private void WritePackRatClass(SourceFile sourceFile, ClassDeclarationSyntax modelClass, CSharpWriter writer)
		{
			string className = modelClass.Identifier.ToString() + "PackRat";
			writer.WriteLine($"public class {className}");
			writer.WriteOpeningCurlyBrace();
			IEnumerable<IFieldSymbol> fields = sourceFile.GetFields(modelClass);
			bool isFirstField = true;
			foreach (IFieldSymbol field in fields)
			{
				WritePackRatField(sourceFile, modelClass, field, writer);

				if (isFirstField)
				{
					writer.WriteLine(string.Empty);
					isFirstField = false;
				}
			}
			writer.WriteClosingCurlyBrace();
		}

		private void WritePackRatField(
			SourceFile sourceFile, 
			ClassDeclarationSyntax modelClass, 
			IFieldSymbol field,
			CSharpWriter writer
		)
		{
			writer.WriteLine($"// {field.Name}");
		}
		#endregion
	}
}
